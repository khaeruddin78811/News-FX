<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تحلیل تکنیکال | News-FX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Vazirmatn', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    header, footer {
      background-color: #1a1a2e;
      color: white;
      text-align: center;
      padding: 1rem;
    }
    nav {
      background-color: #16213e;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      padding: 1rem;
    }
    nav a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      color: #00d4ff;
    }
    .content {
      max-width: 1200px;
      margin: auto;
      padding: 1rem;
    }
    .market-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .market-box {
      background-color: #2c2c2c;
      color: #fff;
      border-radius: 8px;
      padding: 10px;
      width: 140px;
      text-align: center;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s;
    }
    .market-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .symbol { font-weight: bold; font-size: 1.1em; }
    .price { font-size: 1.3em; margin: 5px 0; }
    .change { font-size: 0.9em; }
    .remove-btn {
      position: absolute;
      top: 4px;
      left: 6px;
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 12px;
    }
    .add-symbol {
      background-color: #009688;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      text-align: center;
      margin: 15px auto;
      width: fit-content;
      transition: background 0.3s;
    }
    .add-symbol:hover {
      background-color: #00796b;
    }
    .chart-container iframe {
      width: 100%;
      height: 500px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .news-container {
      margin-top: 2rem;
      height: 450px;
    }
    .news-container h2 {
      text-align: center;
      color: #1a1a2e;
    }
    .news-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .loading {
      color: #7f8c8d;
      text-align: center;
      padding: 10px;
    }
    .error {
      color: #ff4757;
      text-align: center;
      padding: 10px;
    }
    @media (max-width: 600px) {
      .market-box {
        width: calc(50% - 20px);
      }
      .chart-container iframe {
        height: 400px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>📊 تحلیل تکنیکال بازار</h1>
</header>
<nav>
  <a href="index.html">خانه</a>
  <a href="economic.html">داده‌های اقتصادی</a>
  <a href="technical.html">تحلیل تکنیکال</a>
  <a href="fundamental.html">تحلیل فاندامنتال</a>
</nav>
<div class="content">
  <div class="market-selector" id="marketList">
    <!-- نمادها توسط جاوااسکریپت ایجاد می‌شوند -->
  </div>
  <div class="add-symbol" onclick="addSymbol()">➕ افزودن نماد جدید</div>
  
  <div class="chart-container">
    <iframe id="tv_chart" src="https://s.tradingview.com/widgetembed/?frameElementId=tv_chart&symbol=OANDA%3AEURUSD&interval=30&hidesidetoolbar=1&symboledit=1&saveimage=1&toolbarbg=f1f3f6&studies=[]&theme=Light&style=1&timezone=Etc%2FUTC&locale=fa" allowtransparency="true" scrolling="no"></iframe>
  </div>
  
  <div class="news-container">
    <h2>📰 اخبار مرتبط</h2>
    <iframe id="news_frame" src="https://www.forexfactory.com/search?q=EURUSD"></iframe>
  </div>
</div>
<footer>
  <p>© 2025 News-FX | تحلیل تکنیکال بازار</p>
</footer>

<script>
// پیکربندی اصلی
const API_KEY = '2a2b8e8e5e0d4c7a8b1f4d8e9d3f5a7c'; // API Key رایگان از Twelvedata
const DEFAULT_SYMBOLS = ['XAUUSD', 'EURUSD', 'GBPUSD'];
const REFRESH_INTERVAL = 30000; // بروزرسانی هر 30 ثانیه

// ذخیره نمادها
let symbols = [...DEFAULT_SYMBOLS];
let refreshInterval;

// مقداردهی اولیه
document.addEventListener('DOMContentLoaded', () => {
  initSymbols();
  startAutoRefresh();
});

// ایجاد نمادهای پیش‌فرض
function initSymbols() {
  const marketList = document.getElementById('marketList');
  marketList.innerHTML = '';
  
  symbols.forEach(symbol => {
    createSymbolBox(symbol);
    fetchPrice(symbol);
  });
}

// ایجاد جعبه نماد
function createSymbolBox(symbol) {
  const marketList = document.getElementById('marketList');
  const box = document.createElement('div');
  box.className = 'market-box';
  box.setAttribute('data-symbol', symbol);
  box.onclick = () => updateChart(`OANDA:${symbol}`, symbol);
  
  box.innerHTML = `
    <button class="remove-btn" onclick="removeSymbol('${symbol}', event)">×</button>
    <div class="symbol">${getSymbolName(symbol)}</div>
    <div class="price" id="price-${symbol}">...</div>
    <div class="change" id="change-${symbol}">...</div>
  `;
  
  marketList.appendChild(box);
}

// دریافت نام نمایشی نماد
function getSymbolName(symbol) {
  const names = {
    'XAUUSD': 'طلا',
    'EURUSD': 'یورو/دلار',
    'GBPUSD': 'پوند/دلار',
    'USDJPY': 'دلار/ین',
    'USDCAD': 'دلار/دلار کانادا',
    'AUDUSD': 'دلار استرالیا/دلار',
    'NZDUSD': 'دلار نیوزلند/دلار',
    'USDCHF': 'دلار/فرانک سوئیس'
  };
  
  return names[symbol] || symbol;
}

// حذف نماد
function removeSymbol(symbol, event) {
  event.stopPropagation();
  symbols = symbols.filter(s => s !== symbol);
  
  const box = document.querySelector(`.market-box[data-symbol="${symbol}"]`);
  if (box) box.remove();
}

// افزودن نماد جدید
function addSymbol() {
  const symbol = prompt("نماد مورد نظر را وارد کنید (مثلاً: USDJPY):");
  if (!symbol) return;
  
  const normalizedSymbol = symbol.trim().toUpperCase();
  
  if (!/^[A-Z]{6}$/.test(normalizedSymbol)) {
    alert('فرمت نماد نامعتبر است. باید 6 حرف باشد (مثال: USDJPY)');
    return;
  }
  
  if (symbols.includes(normalizedSymbol)) {
    alert('این نماد قبلاً اضافه شده است!');
    return;
  }
  
  symbols.push(normalizedSymbol);
  createSymbolBox(normalizedSymbol);
  fetchPrice(normalizedSymbol);
}

// دریافت قیمت لحظه‌ای
async function fetchPrice(symbol) {
  const fromCurrency = symbol.substring(0, 3);
  const toCurrency = symbol.substring(3, 6);
  
  try {
    const response = await fetch(
      `https://api.twelvedata.com/price?symbol=${fromCurrency}/${toCurrency}&apikey=${API_KEY}`
    );
    
    const data = await response.json();
    
    if (data.price) {
      updatePriceDisplay(symbol, parseFloat(data.price));
    } else {
      showError(symbol, data.message || 'خطا در دریافت داده');
    }
  } catch (error) {
    showError(symbol, 'خطای ارتباط با سرور');
  }
}

// به‌روزرسانی نمایش قیمت
function updatePriceDisplay(symbol, price) {
  const priceElement = document.getElementById(`price-${symbol}`);
  const changeElement = document.getElementById(`change-${symbol}`);
  
  if (!priceElement || !changeElement) return;
  
  priceElement.textContent = price.toFixed(4);
  priceElement.classList.remove('loading', 'error');
  
  // محاسبه تغییرات (برای سادگی از تغییرات تصادفی استفاده می‌شود)
  const change = (Math.random() * 0.2 - 0.1).toFixed(2);
  const isPositive = parseFloat(change) >= 0;
  
  changeElement.innerHTML = `
    <span style="color: ${isPositive ? '#2ed573' : '#ff4757'}">
      ${isPositive ? '▲' : '▼'} ${Math.abs(change)}%
    </span>
  `;
}

// نمایش خطا
function showError(symbol, message) {
  const priceElement = document.getElementById(`price-${symbol}`);
  const changeElement = document.getElementById(`change-${symbol}`);
  
  if (priceElement) {
    priceElement.textContent = 'خطا';
    priceElement.classList.add('error');
  }
  
  if (changeElement) {
    changeElement.textContent = message;
    changeElement.classList.add('error');
  }
}

// به‌روزرسانی چارت
function updateChart(symbol, newsSymbol) {
  const baseUrl = "https://s.tradingview.com/widgetembed/?frameElementId=tv_chart";
  const params = `&symbol=${symbol}&interval=30&hidesidetoolbar=1&symboledit=1&saveimage=1&toolbarbg=f1f3f6&studies=[]&theme=Light&style=1&timezone=Etc%2FUTC&locale=fa`;
  document.getElementById("tv_chart").src = baseUrl + params;
  document.getElementById("news_frame").src = `https://www.forexfactory.com/search?q=${newsSymbol}`;
}

// بروزرسانی خودکار قیمت‌ها
function startAutoRefresh() {
  if (refreshInterval) clearInterval(refreshInterval);
  
  refreshInterval = setInterval(() => {
    symbols.forEach(symbol => fetchPrice(symbol));
  }, REFRESH_INTERVAL);
}

// مقداردهی اولیه نمادها
symbols.forEach(symbol => createSymbolBox(symbol));
symbols.forEach(symbol => fetchPrice(symbol));
</script>
</body>
</html>
